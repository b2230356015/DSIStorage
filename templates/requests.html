{% extends "base.html" %}

{% block content %}
	<h1>İstekler</h1>
	<hr>

	{% with messages = get_flashed_messages(with_categories=true) %}
		{% if messages %}
			{% for category, message in messages %}
				<div class="alert alert-{{ category }} mt-3">{{ message }}</div>
			{% endfor %}
		{% endif %}
	{% endwith %}

	{% if current_user.role == 'Bilgi Müdür' %}
		<div class="mb-3">
			<label for="sube_id" class="form-label">Şube Seçiniz</label>
			<select id="sube_id" name="sube_id" class="form-select" onchange="filterBySube()">
				<option value="">-- Bütün Şubeler --</option>
				{% for sube in sube_list %}
					<option value="{{ sube.id }}" {% if selected_sube_id == sube.id|string %}selected{% endif %}>
						{{ sube.name }}
					</option>
				{% endfor %}
			</select>
		</div>
		<div class="mb-3">
			<label for="person_id" class="form-label">Personel Seçiniz</label>
			<select id="person_id" name="person_id" class="form-select" onchange="filterByPerson()">
				<option value="">-- Bütün Personeller --</option>
				{% for person in personnel %}
					<option value="{{ person.id }}" {% if selected_person_id == person.id|string %}selected{% endif %}>
						{{ person.name }} {{ person.surname }}
					</option>
				{% endfor %}
			</select>
		</div>
		<script>
            function filterBySube() {
                const subeId = document.getElementById('sube_id').value;
                const url = new URL(window.location.href);
                if (subeId) {
                    url.searchParams.set('sube_id', subeId);
                } else {
                    url.searchParams.delete('sube_id');
                }
                url.searchParams.delete('person_id'); // reset person filter
                window.location.href = url.toString();
            }

            function filterByPerson() {
                const personId = document.getElementById('person_id').value;
                const url = new URL(window.location.href);
                if (personId) {
                    url.searchParams.set('person_id', personId);
                } else {
                    url.searchParams.delete('person_id');
                }
                window.location.href = url.toString();
            }
		</script>
	{% endif %}

	{% if current_user.role == 'Şube Müdürü' %}
		<div class="mb-3">
			<label for="person_id" class="form-label">Filter by Person</label>
			<select id="person_id" name="person_id" class="form-select" onchange="filterByPerson()">
				<option value="">-- Bütün Personeller --</option>
				{% for person in personnel %}
					<option value="{{ person.id }}" {% if selected_person_id == person.id|string %}selected{% endif %}>
						{{ person.name }} {{ person.surname }}
					</option>
				{% endfor %}
			</select>
		</div>
		<script>
            function filterByPerson() {
                const personId = document.getElementById('person_id').value;
                const url = new URL(window.location.href);
                if (personId) {
                    url.searchParams.set('person_id', personId);
                } else {
                    url.searchParams.delete('person_id');
                }
                window.location.href = url.toString();
            }
		</script>
	{% endif %}

	{% if current_user.role in ['Personel', 'Şube Müdürü'] %}
		<div class="d-flex justify-content-between align-items-center mb-3">
			{% if current_user.role == 'Personel' %}
				<h2>Benim İsteklerim</h2>
			{% else %}
				<h2>Şube İstekleri</h2>
			{% endif %}
			<button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#requestItemModal">
				Eşya İsteğinde Bulun
			</button>
		</div>
	{% endif %}
	<input type="text" id="searchInput" onkeyup="searchTable()" placeholder="Ara..." class="form-control mb-3">

	<table class="table table-striped" id="requestsTable">
		<thead>
		<tr>
			<th>ID
				<button class="sort-button" onclick="sortTable('id')">⇅</button>
			</th>
			{% if current_user.role == 'Bilgi Müdür' %}
				<th>Şube
					<button class="sort-button" onclick="sortTable('sube')">⇅</button>
				</th>
			{% endif %}
			<th>İsteyen
				<button class="sort-button" onclick="sortTable('name')">⇅</button>
			</th>
			<th>Eşya
				<button class="sort-button" onclick="sortTable('item_name')">⇅</button>
			</th>
			<th>Sebep</th>
			<th>Durum
				<button class="sort-button" onclick="sortTable('status')">⇅</button>
			</th>
			<th>Şube Müdürü Yorumu</th>
			<th>BT Yorumu</th>
			{% if current_user.role in ['Şube Müdürü', 'Bilgi Müdür', 'admin'] %}
				<th>İşlemler</th>
			{% endif %}
		</tr>
		</thead>
		<tbody>
		{% for request in requests %}
			<tr>
				<td>{{ request.id }}</td>
				{% if current_user.role == 'Bilgi Müdür' %}
					<td>{{ request.sube }}</td>
				{% endif %}
				<td>{{ request.name }} {{ request.surname }}</td>
				<td>{{ request.item_name }}</td>
				<td>{{ request.reason }}</td>
				<td>
					{% if request.status == 'approved' %}
						Onaylandı
					{% elif request.status == 'rejected' %}
						Reddedildi
					{% elif request.status == 'pending_manager' %}
						Şube Müdürü Onayı Bekliyor
					{% elif request.status == 'pending_it' %}
						BT Onayı Bekliyor
					{% else %}
						{{ request.status }}
					{% endif %}
				</td>
				<td>{{ request.manager_comment or 'N/A' }}</td>
				<td>{{ request.it_comment or 'N/A' }}</td>
				<td>
					{% if (current_user.role == 'Şube Müdürü' or current_user.role == 'admin') and request.status == 'pending_manager' %}
						<button type="button" class="btn btn-sm btn-success"
						        onclick="openConfirmationModal('approve', {{ request.id }}, '{{ url_for('approve_request', request_id=request.id, approver_type='manager') }}')">
							Onayla
						</button>
						<button type="button" class="btn btn-sm btn-danger"
						        onclick="openConfirmationModal('reject', {{ request.id }}, '{{ url_for('reject_request', request_id=request.id, approver_type='manager') }}')">
							Reddet
						</button>
					{% elif (current_user.role == 'Bilgi Müdür' or current_user.role == 'admin') and request.status == 'pending_it' %}
						<button type="button" class="btn btn-sm btn-success"
						        onclick="openConfirmationModal('approve', {{ request.id }}, '{{ url_for('approve_request', request_id=request.id, approver_type='it') }}')">
							Onayla
						</button>
						<button type="button" class="btn btn-sm btn-danger"
						        onclick="openConfirmationModal('reject', {{ request.id }}, '{{ url_for('reject_request', request_id=request.id, approver_type='it') }}')">
							Reddet
						</button>
					{% endif %}
				</td>
			</tr>
		{% else %}
			<tr>
				<td colspan="9" class="text-center">İstek Bulunamadı</td>
			</tr>
		{% endfor %}
		</tbody>
	</table>
	<script>
        function searchTable() {
            const input = document.getElementById("searchInput");
            const filter = input.value.toLowerCase();
            const table = document.getElementById("requestsTable");
            const rows = table.querySelectorAll("tbody tr");

            rows.forEach(row => {
                const text = row.textContent.toLowerCase();
                row.style.display = text.includes(filter) ? "" : "none";
            });
        }
	</script>

	<script>
        function sortTable(column) {
            const url = new URL(window.location.href);
            const currentSortBy = url.searchParams.get('sort_by');
            const currentSortOrder = url.searchParams.get('sort_order') || 'asc';

            if (currentSortBy === column) {
                url.searchParams.set('sort_order', currentSortOrder === 'asc' ? 'desc' : 'asc');
            } else {
                url.searchParams.set('sort_by', column);
                url.searchParams.set('sort_order', 'asc');
            }

            window.location.href = url.toString();
        }
	</script>

	<style>
        .sort-button {
            background: none;
            border: none;
            cursor: pointer;
            font-size: 1rem;
            margin-left: 5px;
            padding: 0;
        }

        .sort-button:hover {
            color: #007bff;
        }
	</style>

	{% if current_user.role in ['Personel', 'Şube Müdürü', 'admin'] %}
		<div class="modal fade" id="requestItemModal" tabindex="-1" aria-labelledby="requestItemModalLabel"
		     aria-hidden="true">
			<div class="modal-dialog">
				<div class="modal-content">
					<div class="modal-header">
						<h5 class="modal-title" id="requestItemModalLabel">Eşya İsteğinde Bulun</h5>
						<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
					</div>
					<form action="{{ url_for('request_item') }}" method="POST">
						<div class="modal-body">
							<div class="mb-3">
								<label for="itemName" class="form-label">Eşya Adı</label>
								<select class="form-select" id="itemName" name="item_name" required>
									<option value="" disabled selected>Eşya Seçiniz</option>
									<option value="Bilgisayar">Bilgisayar</option>
									<option value="Fare">Fare</option>
									<option value="Klavye">Klavye</option>
									<option value="Monitör">Monitör</option>
									<option value="Telefon">Telefon</option>
									<option value="Yazıcı">Yazıcı</option>
								</select>
							</div>
							<div class="mb-3">
								<label for="reason" class="form-label">Sebep</label>
								<textarea class="form-control" id="reason" name="reason" rows="3" required></textarea>
							</div>
						</div>
						<div class="modal-footer">
							<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Kapat</button>
							<button type="submit" class="btn btn-primary">Onayla</button>
						</div>
					</form>
				</div>
			</div>
		</div>
	{% endif %}

	<!-- Confirmation Modal -->
	<!-- Confirmation Modal -->
	<div class="modal fade" id="confirmationModal" tabindex="-1" aria-labelledby="confirmationModalLabel"
	     aria-hidden="true">
		<div class="modal-dialog">
			<div class="modal-content">
				<div class="modal-header">
					<h5 class="modal-title" id="confirmationModalLabel">Onay / Red</h5>
					<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Kapat"></button>
				</div>
				<form id="confirmationForm" method="POST">
					<div class="modal-body">
						<p id="actionLabel"></p>
						<input type="hidden" name="action" id="actionType">
						<input type="hidden" name="request_id" id="requestId">

						<div class="mb-3">
							<label for="comment" class="form-label">Yorum</label>
							<textarea class="form-control" name="comment" id="comment"></textarea>
						</div>
					</div>
					<div class="modal-footer">
						<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Kapat</button>
						<button type="submit" class="btn btn-primary">Gönder</button>
					</div>
				</form>
			</div>
		</div>
	</div>



	<script>
        let confirmationModal;

        document.addEventListener("DOMContentLoaded", () => {
            confirmationModal = new bootstrap.Modal(document.getElementById('confirmationModal'));
        });

        function openConfirmationModal(action, requestId, formAction) {
            const actionLabel = document.getElementById('actionLabel');
            if (action === 'approve') {
                actionLabel.textContent = "Bu isteği onaylamak üzeresiniz.";
            } else {
                actionLabel.textContent = "Bu isteği reddetmek üzeresiniz.";
            }

            document.getElementById('actionType').value = action;
            document.getElementById('requestId').value = requestId;
            document.getElementById('confirmationForm').action = formAction;

            confirmationModal.show();
        }
	</script>

{% endblock %}
